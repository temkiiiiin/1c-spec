# Тезисы

* Торговая компания покупает и продает товары/услуги. Товары и услуги указываются в одной табличной части
* Учет товаров по складам не ведется
* Контроль остатков с оповещением о нехватке товаров при продаже
* Списание себестоимости товаров должно быть организовано по партиям и зависеть от текущей учетной политики
* Учетная политика устанавливается год. На следующий год может измениться
* Структуры требуемых отчетов
  * Продажи: Номенклатура, Количество, Себестоимость, Стоимость, Прибыль, где Прибыль считается как "Стоимость - Себестоимость"
  
        |   Номенклатура    |   Количество  |   Себестоимость   |   Стоимость   |   Прибыль |
        -------------------------------------------------------------------------------------
        |   Торт Тирамису   |   2           |   1400            |   2600        |   1200    |
        |   Кекс            |   6           |   240             |   600         |   360     |
        |   Доставка        |   1           |                   |   100         |   100     |
    
  * Остатки: Номенклатура, Партия, Количество, Стоимость с группировкой по полю Номенклатура
  
        |   Номенклатура    |   Партия                  |   Количество  |   Стоимость   |
        ---------------------------------------------------------------------------------
        |   Торт Тирамису   |                           |   3           |   2100        |
        |                   |   Приходная накладная 1   |   2           |   1400        |
        |                   |   Приходная накладная 2   |   1           |   700         |
        |   Кекс            |                           |   10          |   400         |
        |                   |   Приходная накладная 1   |   7           |   280         |
        |                   |   Приходная накладная 3   |   3           |   120         |

## Решение

### Исследование тезисов

* ***"Торговая компания покупает и продает товары/услуги. Товары и услуги указываются в одной табличной части".*** Для операций покупки/продажи потребуются 2 документа - "Приходная накладная" и "Расходная накладная". Среди товаров будут услуги, значит, требуется справочник "Товары" с признаком, услуга это или нет.
* ***"Учет товаров по складам не ведется".*** Значит, весть товар организации хранится на одном складе и хранить остатки в разрезе складов не требуется.
* ***"Контроль остатков с оповещением о нехватке товаров при продаже".*** При проведении документа "Расходная накладная" необходимо учитывать остатки товаров и, если товара не хватает, запрещать проводить документ, сообщать о нехватке товара.
* ***"Списание себестоимости товаров должно быть организовано по партиям и зависеть от текущей учетной политики. Учетная политика устанавливается год. На следующий год может измениться".*** Нужно вести учет в разрезе партий. Т.к. значения учетной политики изменяться не будут, для их хранения используем объект Перечисление. Списание стоимости нужно организовать по методу, установленному учетной политикой на текущий год. Для учетной политики будем использовать регистр сведений с периодичностью "Год".

Исходя из структуры требуемых отчетов видно, что нужно знать остатки товаров и продажи. В обоих случаях будем использовать регистры накопления. Для учета остатков - регистр накопления Остатки товаров с полями Номенклатура, Партия, Количество, Стоимость, где партия - документ "Приходная накладная". Для учета продаж буем использовать оборотный регистр накопления с полями Номенклатура, Количество, Стоимость, Себестоимость. Прибыль записывать не будем, так как ее можно рассчитать как "Стоимость - Себестоимость".

### Разработка

#### Начнем разработку с изменения структуры данных

Структура измененных объектов:

* Справочники
  * Номенклатура
    * Реквизиты
      * ВидНоменклатуры (ПеречислениеСсылка.ВидыНоменклатуры)
* Регистры сведений
  * УчетнаяПолитика
    * Периодичность - В пределах года
    * Ресурсы
      * УчетнаяПолитика (ПеречислениеСсылка.УчетнаяПолитика)
* Регистры накопления
  * ОстаткиНоменклатуры
    * Вид регистра - Остатки
    * Измерения
      * Номенклатура (СправочникСсылка.Номенклатура)
      * Партия (ДокументСсылка.ПриходнаяНакладная)
    * Ресурсы
      * Количество (Число, 10.0)
      * Стоимость (Число, 12.2)
  * Продажи
    * Вид регистра - Обороты
    * Измерения
      * Номенклатура (СправочникСсылка.Номенклатура)
    * Ресурсы
      * Количество (Число, 10.0)
      * Стоимость (Число, 12.2)
      * Себестоимость (Число, 12.2)

### Проведение документа Приходная накладная

* Способ 1. Для создания движений по документу воспользуемся Конструктором движений. Он формирует такой код:
    ```1C
    Процедура ОбработкаПроведения(Отказ, Режим)
      // регистр ОстаткиНоменклатуры Приход
      Движения.ОстаткиНоменклатуры.Записывать = Истина;
      Для Каждого ТекСтрокаСписокНоменклатуры Из СписокНоменклатуры Цикл
        Движение = Движения.ОстаткиНоменклатуры.Добавить();
        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
        Движение.Период = Дата;
        Движение.Номенклатура = ТекСтрокаСписокНоменклатуры.Номенклатура;
        Движение.Партия = Ссылка;
        Движение.Количество = ТекСтрокаСписокНоменклатуры.Количество;
        Движение.Стоимость = ТекСтрокаСписокНоменклатуры.Сумма;
      КонецЦикла;
    КонецПроцедуры
    ```
  Плюсы заполнения движений конструктором:
  * Документ уже в памяти, поэтому его не нужно читать из базы
  
  Минусы:
  * Для того, чтобы избежать попадания на остатки услуг, нужно изменить код. Для получении значения поля ВидНоменклатуры элемента справочника Номенклатура система выполнит неявный запрос к БД, что повлияет на производительность во время проведения документа
    ```1C
    Процедура ОбработкаПроведения(Отказ, РежимПроведения)
       // регистр ОстаткиТоваров Приход
       Движения.ОстаткиТоваров.Записывать = Истина;
       Для Каждого ТекСтрокаТовары Из Товары Цикл
            Если ТекСтрокаСписокНоменклатуры.Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Услуга Тогда
               Продолжить;
            КонецЕсли;
            Движение = Движения.ОстаткиТоваров.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
            Движение.Период = Дата;
            Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
            Движение.Партия = Ссылка;
            Движение.Количество = ТекСтрокаТовары.Количество;
            Движение.Стоимость = ТекСтрокаТовары.Стоимость;
          КонецЕсли;
       КонецЦикла;
    КонецПроцедуры
    ```
  * Не производится группировка по номенклатуре, из-за чего в движения по ней заполняются несколько раз

* Способ 2. Перед заполнением движений выполним запрос к БД, в котором выберем все записи табличной части этого документа без услуг и сгруппируем их по номенклатуре:
    ```1C
    Процедура ОбработкаПроведения(Отказ, Режим)
        Запрос = Новый Запрос;
        Запрос.Текст =
            "ВЫБРАТЬ
            |    ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
            |    &Период,
            |    ПриходнаяНакладнаяСписокНоменклатуры.Ссылка КАК Партия,
            |    ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура,
            |    СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
            |    СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Стоимость
            |ИЗ
            |    Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
            |ГДЕ
            |    ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
            |    И НЕ ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Услуга)
            |
            |СГРУППИРОВАТЬ ПО
            |    ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура,
            |    ПриходнаяНакладнаяСписокНоменклатуры.Ссылка";

        Запрос.УстановитьПараметр("Период", Дата);
        Запрос.УстановитьПараметр("Ссылка", Ссылка);

        Выборка = Запрос.Выполнить().Выбрать();

        Пока Выборка.Следующий() Цикл
            Движение = Движения.ОстаткиНоменклатуры.Добавить();
            Движение.ВидДвижения = Выборка.ВидДвижения;
            Движение.Период = Выборка.Период;
            Движение.Номенклатура = Выборка.Номенклатура;
            Движение.Партия = Выборка.Партия;
            Движение.Количество = Выборка.Количество;
            Движение.Стоимость = Выборка.Стоимость;
        КонецЦикла;

        Движения.ОстаткиНоменклатуры.Записывать = Истина;
      КонецПроцедуры
    ```

Все поля, которые будут подставляться в записи движений, уже выбраны в запросе и в дальнейшем получаются из выборки. Не забываем в конце (или начале) указать, что при проведении должны записаться данные по регистру Остатки номенклатуры. Остановимся на втором решении, т.к. записи сгруппированы и нет не явных обращений к БД.